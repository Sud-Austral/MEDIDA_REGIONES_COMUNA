<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Delincuencia en Copiap√≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #2d3748;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #4c51bf;
            color: #ffffff;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #3b42ab;
        }
        .tab-button {
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4a5568;
            background-color: #e2e8f0;
        }
        .tab-button.active {
            background-color: #4c51bf;
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .filter-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #cbd5e0;
            background-color: #f7fafc;
        }
        .chart-container {
            position: relative;
            height: 400px; /* Adjusted height for better visibility */
            width: 100%;
        }
        /* Custom header styles */
        .hero-header {
            background: linear-gradient(135deg, #4c51bf 0%, #6b46c1 100%); /* Purple gradient */
            color: #ffffff;
            padding: 40px 20px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            margin-bottom: 30px;
        }
        .hero-header h1 {
            font-size: 3.5rem; /* Larger font size */
            font-weight: 800; /* Extra bold */
            letter-spacing: -0.05em; /* Tighter letter spacing */
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); /* Text shadow */
        }
        .hero-header p {
            font-size: 1.25rem; /* Slightly larger paragraph */
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .hero-header .source-info {
            font-size: 0.875rem; /* Smaller source info */
            opacity: 0.7;
        }

        /* Styles for the new metric cards */
        .metric-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 120px; /* Ensure consistent height */
        }
        .metric-card .icon {
            font-size: 2.5rem; /* Large icon size */
            margin-bottom: 8px;
        }
        .metric-card .title {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }
        .metric-card .value {
            font-size: 1.6rem; /* Value font size adjusted for multiple lines */
            font-weight: 700;
            color: #2c5282; /* Default value color */
            line-height: 1.2; /* Adjust line height for multiline values */
        }
        .metric-card .value.green {
            color: #2f855a; /* Green for positive trends */
        }
        .metric-card .value.red {
            color: #e53e3e; /* Red for negative trends */
        }


        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            .hero-header h1 {
                font-size: 2.5rem; /* Adjust for smaller screens */
            }
            .hero-header p {
                font-size: 1rem;
            }
            .metric-card .value {
                font-size: 1.5rem; /* Further adjust for smaller screens */
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container">
        <!-- Encabezado Elaborado -->
        <header class="hero-header">
            <h1><span class="text-yellow-300">üìà</span> Panorama Delictual en Copiap√≥</h1>
            <p class="text-xl">An√°lisis interactivo de frecuencias de delitos por temporalidad.</p>
            <p class="source-info mt-4">Datos extra√≠dos de la Plataforma de Informaci√≥n Ley STOP de Carabineros de Chile, sistematizados por el Instituto Libertad.</p>
        </header>

        <!-- An√°lisis Textual General -->
        <div class="card mb-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Visi√≥n General de la Situaci√≥n Delictual Anual en Copiap√≥ (2023-2025)</h2>
            <div id="generalAnalysis" class="bg-gray-50 border-l-4 border-gray-300 text-gray-800 p-4 rounded-md">
                <!-- Content will be dynamically generated by JavaScript -->
            </div>
        </div>

        <main>
            <!-- Selector de Temporalidad -->
            <div class="card mb-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Selecciona la Temporalidad</h2>
                <div class="flex flex-wrap gap-3">
                    <button id="tabAnnual" class="tab-button active">Anual</button>
                    <button id="tabMonthly" class="tab-button">Mensual</button>
                    <button id="tabWeekly" class="tab-button">Semanal</button>
                </div>
            </div>

            <!-- Contenedor de Gr√°ficos Anual -->
            <div id="annualContent" class="temporal-content">
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Frecuencia de Delitos - Comparativa Anual (2023-2025)</h2>
                    <p class="text-gray-600 mb-4">Explora las tendencias anuales de los delitos en Copiap√≥. Puedes seleccionar un delito espec√≠fico para ver su evoluci√≥n.</p>

                    <div class="mb-6 flex flex-col md:flex-row items-center gap-4">
                        <label for="annualCrimeSelect" class="font-medium text-gray-700">Seleccionar Delito:</label>
                        <select id="annualCrimeSelect" class="filter-select w-full md:w-auto">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>

                    <div class="chart-container">
                        <canvas id="annualChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Contenedor de Gr√°ficos Mensual -->
            <div id="monthlyContent" class="temporal-content hidden">
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Frecuencia de Delitos - Comparativa Mensual (2024 vs. 2025)</h2>
                    <p class="text-gray-600 mb-4">Observa la distribuci√≥n mensual de los delitos, comparando el comportamiento entre 2024 y 2025 (proyectado).</p>

                    <div class="mb-6 flex flex-col md:flex-row items-center gap-4">
                        <label for="monthlyCrimeSelect" class="font-medium text-gray-700">Seleccionar Delito:</label>
                        <select id="monthlyCrimeSelect" class="filter-select w-full md:w-auto">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>

                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Contenedor de Gr√°ficos Semanal -->
            <div id="weeklyContent" class="temporal-content hidden">
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Frecuencia de Delitos - Comparativa Semanal (2024 vs. 2025)</h2>
                    <p class="text-gray-600 mb-4">Analiza las fluctuaciones recientes semana a semana, comparando las √∫ltimas 12 semanas disponibles de 2024 y 2025.</p>

                    <div class="mb-6 flex flex-col md:flex-row items-center gap-4">
                        <label for="weeklyCrimeSelect" class="font-medium text-gray-700">Seleccionar Delito:</label>
                        <select id="weeklyCrimeSelect" class="filter-select w-full md:w-auto">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>

                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de An√°lisis Textual Din√°mico -->
            <div class="card mt-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">An√°lisis de Tendencias Espec√≠ficas</h2>
                <div id="dynamicAnalysis" class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-md">
                    <!-- Dynamic analysis text will be inserted here by JavaScript -->
                    <p>Seleccione una temporalidad y un delito para ver el an√°lisis.</p>
                </div>
            </div>

            <!-- Secci√≥n de Ilustraciones y Explicaciones -->
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">M√©tricas Clave de Delincuencia</h2>
                <div id="keyMetricsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Metrics will be dynamically inserted here -->
                    <div class="metric-card">
                        <span class="icon">üìÖ</span>
                        <h4 class="title">Total Casos 2024</h4>
                        <p class="value" id="metric1">Cargando...</p>
                    </div>
                    <div class="metric-card">
                        <span class="icon">üìà</span>
                        <h4 class="title">Total Casos 2025 (a la fecha)</h4>
                        <p class="value" id="metric2">Cargando...</p>
                    </div>
                    <div class="metric-card">
                        <span class="icon">üö®</span>
                        <h4 class="title">Delito M√°s Frecuente (2024)</h4>
                        <p class="value" id="metric3-value">Cargando...</p>
                    </div>
                    <div class="metric-card">
                        <span class="icon">üî•</span>
                        <h4 class="title">Delito M√°s Frecuente (2025 a la fecha)</h4>
                        <p class="value" id="metric4-value">Cargando...</p>
                    </div>
                    <div class="metric-card">
                        <span class="icon">‚ÜîÔ∏è</span>
                        <h4 class="title">Variaci√≥n % (2025 vs Mismo Periodo 2024)</h4>
                        <p class="value" id="metric5">Cargando...</p>
                    </div>
                    <div class="metric-card">
                        <span class="icon">‚ö°</span>
                        <h4 class="title">Variaci√≥n % Total (2024 vs 2023)</h4>
                        <p class="value" id="metric6">Cargando...</p>
                    </div>
                    <div class="metric-card">
                        <span class="icon">üî™</span>
                        <h4 class="title">Robos con Violencia (Julio 2025)</h4>
                        <p class="value" id="metric7">Cargando...</p>
                    </div>
                    <div class="metric-card">
                        <span class="icon">üíÄ</span>
                        <h4 class="title">Homicidios y Femicidios (Semana 12 2025)</h4>
                        <p class="value" id="metric8">Cargando...</p>
                    </div>
                </div>
                <div class="space-y-6 mt-8">
                    <div>
                        <h3 class="text-xl font-medium text-gray-800 mb-2">¬øQu√© son estos gr√°ficos?</h3>
                        <p class="text-gray-600">Los gr√°ficos muestran la <strong>frecuencia de ocurrencia</strong> de diferentes tipos de delitos en la Comuna de Copiap√≥. Esto nos ayuda a identificar patrones y cambios a lo largo del tiempo.</p>
                        <ul class="list-disc list-inside text-gray-600 mt-2">
                            <li><strong>Gr√°fico Anual:</strong> Compara la cantidad de casos en los a√±os 2023, 2024 y lo que va de 2025.</li>
                            <li><strong>Gr√°fico Mensual y Semanal:</strong> Muestran el n√∫mero de casos por mes/semana, permitiendo una <strong>comparaci√≥n directa entre 2024 y 2025</strong>. En la vista mensual, los valores futuros de 2025 son proyecciones.</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium text-gray-800 mb-2">¬øC√≥mo interpretar las tendencias?</h3>
                        <p class="text-gray-600">Un <strong>aumento</strong> en la frecuencia puede indicar un incremento real del delito, una mejora en los reportes, o una mayor actividad policial en ciertas √°reas. Una <strong>disminuci√≥n</strong> puede sugerir lo contrario.</p>
                        <p class="text-gray-600 mt-2">Es crucial considerar el <strong>contexto</strong>: cambios en las leyes, operaciones policiales espec√≠ficas, factores socioecon√≥micos, o incluso eventos estacionales pueden influir en estas cifras.</p>
                        <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded-md">
                            <p class="font-semibold">üí° Dato Clave:</p>
                            <p>Las cifras reales de 2025 est√°n disponibles hasta julio para la vista mensual y las √∫ltimas 12 semanas para la semanal. Los valores posteriores a julio en el gr√°fico mensual de 2025 son <strong>proyecciones</strong> basadas en el promedio de los meses ya reportados de 2025, y se visualizan con una **l√≠nea segmentada**.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de "Acerca de" o pie de p√°gina -->
            <footer class="text-center text-gray-500 text-sm mt-8">
                <p>&copy; 2025 Instituto Libertad. Datos proporcionados por Carabineros de Chile (Plataforma Ley STOP).</p>
            </footer>
        </main>
    </div>

    <script>
        // Data from the provided CSV snippets (hardcoded for simplicity in this example)
        // In a real application, this would be dynamically loaded from the files.

        const annualDataRaw =getData1()
        const monthlyDataRaw = getData2()
        const weeklyDataRaw = getData3()

        const crimeTypes = [...new Set(annualDataRaw.map(d => d.Delito))].sort(); // Get unique crime types

        // Chart instances
        let annualChartInstance;
        let monthlyChartInstance;
        let weeklyChartInstance;

        let currentTemporality = 'Annual'; // Track active tab for analysis generation

        // Populate dropdowns
        function populateCrimeSelects() {
            const annualSelect = document.getElementById('annualCrimeSelect');
            const monthlyCrimeSelect = document.getElementById('monthlyCrimeSelect');
            const weeklyCrimeSelect = document.getElementById('weeklyCrimeSelect');

            annualSelect.innerHTML = '<option value="All">Todos los Delitos (Suma)</option>';
            monthlyCrimeSelect.innerHTML = '<option value="All">Todos los Delitos (Suma)</option>';
            weeklyCrimeSelect.innerHTML = '<option value="All">Todos los Delitos (Suma)</option>';

            crimeTypes.forEach(crime => {
                const option1 = document.createElement('option');
                option1.value = crime;
                option1.textContent = crime;
                annualSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = crime;
                option2.textContent = crime;
                monthlyCrimeSelect.appendChild(option2);

                const option3 = document.createElement('option');
                option3.value = crime;
                option3.textContent = crime;
                weeklyCrimeSelect.appendChild(option3);
            });
        }

        // Function to generate the general analysis text
        function generateGeneralAnalysisText() {
            const total2023 = annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2023"], 0);
            const total2024 = annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2024"], 0);
            const total2025Partial = annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2025 (a la fecha)"], 0);

            let contentHTML = `<p class="mb-2">El presente an√°lisis ofrece una visi√≥n general de la evoluci√≥n delictual en la Comuna de Copiap√≥, bas√°ndose en la frecuencia total de casos reportados para los a√±os 2023, 2024 y los datos parciales de 2025 hasta la fecha de este informe. La informaci√≥n recopilada abarca una diversidad de delitos, desde aquellos de alta connotaci√≥n social como Homicidios y Femicidios, hasta delitos contra la propiedad, violencia intrafamiliar e incivilidades.</p>`;

            contentHTML += `<ul class="list-disc list-inside space-y-2 text-gray-700">`;

            // Cifras generales
            contentHTML += `<li><strong>Cifras Anuales Totales:</strong>`;
            contentHTML += `<ul>`;
            contentHTML += `<li>En 2023, se registraron <strong>${total2023.toLocaleString('es-CL')}</strong> casos.</li>`;
            contentHTML += `<li>Para 2024, la cifra fue de <strong>${total2024.toLocaleString('es-CL')}</strong> casos.</li>`;
            contentHTML += `<li>Hasta la fecha en 2025, se han reportado <strong>${total2025Partial.toLocaleString('es-CL')}</strong> casos.</li>`;
            contentHTML += `</ul>`;
            contentHTML += `</li>`;

            // Tendencia general anual
            let trendText = '';
            if (total2023 > 0 && total2024 > 0) {
                const change23_24 = ((total2024 - total2023) / total2023 * 100).toFixed(1);
                trendText += `Se observ√≥ un <strong>${change23_24 > 0 ? 'incremento' : 'descenso'}</strong> general del <strong>${Math.abs(change23_24)}%</strong> entre 2023 y 2024. `;
            }
            if (total2024 > 0 && total2025Partial > 0) {
                const change24_25 = ((total2025Partial - total2024) / total2024 * 100).toFixed(1);
                trendText += `Para el periodo de 2025 (a la fecha) en comparaci√≥n con el mismo periodo de 2024, se registra un <strong>${change24_25 > 0 ? 'aumento' : 'disminuci√≥n'}</strong> del <strong>${Math.abs(change24_25)}%</strong>.`;
            } else if (total2025Partial > 0) {
                 trendText += `Los datos de 2025 muestran una tendencia inicial de <strong>${total2025Partial > 0 ? 'aumento' : 'descenso'}</strong>.`;
            } else {
                 trendText += `La informaci√≥n para 2025 a√∫n es limitada para establecer una tendencia clara.`;
            }
            contentHTML += `<li><strong>Tendencia General Anual:</strong> ${trendText}</li>`;

            // An√°lisis de delitos m√°s/menos frecuentes (basado en 2024, como a√±o completo m√°s reciente)
            let crimeFrequencies = annualDataRaw.map(d => ({
                delito: d.Delito,
                total: d["Frecuencia 2024"]
            }));
            crimeFrequencies.sort((a, b) => b.total - a.total);

            const mostFrequentCrime = crimeFrequencies[0];
            const secondMostFrequentCrime = crimeFrequencies[1]; // Get second most frequent
            const leastFrequentCrime = crimeFrequencies[crimeFrequencies.length - 1];
            const secondLeastFrequentCrime = crimeFrequencies[crimeFrequencies.length - 2]; // Get second least frequent


            contentHTML += `<li><strong>Delitos M√°s y Menos Frecuentes (2024):</strong>`;
            contentHTML += `<ul>`;
            contentHTML += `<li>Los delitos m√°s frecuentes incluyen: <strong>${mostFrequentCrime.delito}</strong> con <strong>${mostFrequentCrime.total.toLocaleString('es-CL')}</strong> casos y <strong>${secondMostFrequentCrime.delito}</strong> con <strong>${secondMostFrequentCrime.total.toLocaleString('es-CL')}</strong> casos.</li>`;
            contentHTML += `</ul>`;
            contentHTML += `</li>`;


            // An√°lisis de meses con m√°s/menos frecuencia (basado en 2025 actual y 2024 completo)
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            let monthlyTotals2025 = new Array(7).fill(0); // Only up to July for 2025 actual
            let monthlyTotals2024 = new Array(12).fill(0);

            monthlyDataRaw.forEach(d => {
                if (d.A√±o === 2025) {
                    for (let i = 0; i < 7; i++) {
                        if (d[months[i]] !== undefined) {
                            monthlyTotals2025[i] += d[months[i]];
                        }
                    }
                } else if (d.A√±o === 2024) {
                    for (let i = 0; i < 12; i++) {
                        if (d[months[i]] !== undefined) {
                            monthlyTotals2024[i] += d[months[i]];
                        }
                    }
                }
            });

            const maxMonth2025Index = monthlyTotals2025.indexOf(Math.max(...monthlyTotals2025));
            const minMonth2025Index = monthlyTotals2025.indexOf(Math.min(...monthlyTotals2025));

            const maxMonth2024Index = monthlyTotals2024.indexOf(Math.max(...monthlyTotals2024));
            const minMonth2024Index = monthlyTotals2024.indexOf(Math.min(...monthlyTotals2024));


            contentHTML += `<li><strong>Patrones Mensuales (Frecuencia Total):</strong>`;
            contentHTML += `<ul>`;
            contentHTML += `<li>En 2024, el mes con <strong>mayor frecuencia</strong> fue <strong>${months[maxMonth2024Index]}</strong> (${monthlyTotals2024[maxMonth2024Index].toLocaleString('es-CL')} casos).</li>`;
            contentHTML += `<li>El mes con <strong>menor frecuencia</strong> en 2024 fue <strong>${months[minMonth2024Index]}</strong> (${monthlyTotals2024[minMonth2024Index].toLocaleString('es-CL')} casos).</li>`;
            if (monthlyTotals2025.length > 0 && monthlyTotals2025.some(val => val > 0)) {
                contentHTML += `<li>Para 2025 (hasta julio), se observa un pico en <strong>${months[maxMonth2025Index]}</strong> con <strong>${monthlyTotals2025[maxMonth2025Index].toLocaleString('es-CL')}</strong> casos, y el punto m√°s bajo en <strong>${months[minMonth2025Index]}</strong> con <strong>${monthlyTotals2025[minMonth2025Index].toLocaleString('es-CL')}</strong> casos.</li>`;
            }
            contentHTML += `</ul>`;
            contentHTML += `</li>`;

            contentHTML += `</ul>`;
            document.getElementById('generalAnalysis').innerHTML = contentHTML;
        }


        // Function to generate dynamic analysis text
        function generateAnalysisText(temporality, selectedCrime) {
            let analysisText = "";
            let dataName = selectedCrime === 'All' ? 'Todos los delitos' : selectedCrime;

            if (temporality === 'Annual') {
                const data = annualDataRaw.find(d => d.Delito === selectedCrime) || {};
                const total2023 = selectedCrime === 'All' ? annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2023"], 0) : data["Frecuencia 2023"] || 0;
                const total2024 = selectedCrime === 'All' ? annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2024"], 0) : data["Frecuencia 2024"] || 0;
                const total2025 = selectedCrime === 'All' ? annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2025 (a la fecha)"], 0) : data["Frecuencia 2025 (a la fecha)"] || 0;

                analysisText += `An√°lisis Anual para <strong>${dataName}</strong>:\n\n`;
                analysisText += `En 2023, se registraron <strong>${total2023.toLocaleString('es-CL')}</strong> casos. Para 2024, la cifra fue de <strong>${total2024.toLocaleString('es-CL')}</strong> casos. Hasta la fecha en 2025, se han reportado <strong>${total2025.toLocaleString('es-CL')}</strong> casos.\n\n`;

                const change23_24 = total2023 > 0 ? ((total2024 - total2023) / total2023 * 100).toFixed(1) : (total2024 > 0 ? "un aumento significativo" : "sin cambios");
                const change24_25 = total2024 > 0 ? ((total2025 - total2024) / total2024 * 100).toFixed(1) : (total2025 > 0 ? "un aumento significativo" : "sin cambios");

                if (change23_24 !== "sin cambios") {
                    analysisText += `Se observ√≥ un <strong>${change23_24 > 0 ? 'aumento' : 'disminuci√≥n'}</strong> del <strong>${Math.abs(change23_24)}%</strong> entre 2023 y 2024. `;
                } else {
                     analysisText += `La tendencia se mantuvo estable entre 2023 y 2024. `;
                }

                if (change24_25 !== "sin cambios") {
                    analysisText += `Entre 2024 y 2025 (a la fecha), se registr√≥ un <strong>${change24_25 > 0 ? 'aumento' : 'disminuci√≥n'}</strong> del <strong>${Math.abs(change24_25)}%</strong>.`;
                } else {
                     analysisText += `Entre 2024 y 2025 (a la fecha), no hubo variaciones significativas.`;
                }


            } else if (temporality === 'Monthly') {
                const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                let data2024 = [];
                let data2025Actual = []; // Stores actual 2025 data points
                let sum2025Reported = 0; // Initialize here
                let count2025Reported = 0; // Initialize here
                let currentMonthIndex = -1; // Initialize here

                // Re-calculate data to ensure consistency with chart rendering
                if (selectedCrime === 'All') {
                    months.forEach(month => {
                        const sum24 = monthlyDataRaw.filter(d => d.A√±o === 2024 && d[month] !== undefined).reduce((acc, d) => acc + d[month], 0);
                        data2024.push(sum24);
                        const sum25 = monthlyDataRaw.filter(d => d.A√±o === 2025 && d[month] !== undefined).reduce((acc, d) => acc + d[month], 0);
                        data2025Actual.push(sum25);
                        if (sum25 > 0) {
                            sum2025Reported += sum25;
                            count2025Reported++;
                            currentMonthIndex = months.indexOf(month);
                        }
                    });
                } else {
                    const crimeData2024 = monthlyDataRaw.find(d => d.A√±o === 2024 && d.Delito === selectedCrime);
                    const crimeData2025Specific = monthlyDataRaw.find(d => d.A√±o === 2025 && d.Delito === selectedCrime);
                    months.forEach((month, index) => {
                        const val24 = (crimeData2024 && crimeData2024[month] !== undefined) ? crimeData2024[month] : 0;
                        data2024.push(val24);
                        const val25 = (crimeData2025Specific && crimeData2025Specific[month] !== undefined) ? crimeData2025Specific[month] : 0;
                        data2025Actual.push(val25);
                        if (val25 > 0) {
                            sum2025Reported += val25;
                            count2025Reported++;
                            currentMonthIndex = index;
                        }
                    });
                }

                const average2025 = count2025Reported > 0 ? sum2025Reported / count2025Reported : 0;

                analysisText += `An√°lisis Mensual para <strong>${dataName}</strong>:\n\n`;
                analysisText += `Comparativa entre 2024 y 2025 (hasta <strong>${months[currentMonthIndex || 0]}</strong>):\n`;

                let total2024Partial = data2024.slice(0, currentMonthIndex + 1).reduce((sum, val) => sum + val, 0);
                let total2025Partial = data2025Actual.slice(0, currentMonthIndex + 1).reduce((sum, val) => sum + val, 0);

                if (total2024Partial > 0) {
                     const changePartial = ((total2025Partial - total2024Partial) / total2024Partial * 100).toFixed(1);
                     analysisText += `Se observa un <strong>${changePartial > 0 ? 'incremento' : 'decremento'}</strong> del <strong>${Math.abs(changePartial)}%</strong> en 2025 respecto al mismo per√≠odo de 2024.\n`;
                } else if (total2025Partial > 0) {
                    analysisText += `Se ha registrado un <strong>aumento significativo</strong> en 2025 en comparaci√≥n con el mismo per√≠odo de 2024.\n`;
                } else {
                    analysisText += `Las cifras son <strong>consistentes</strong> en ambos a√±os para el per√≠odo analizado.\n`;
                }


                // Identify peak and low for 2024
                const max2024 = Math.max(...data2024);
                const min2024 = Math.min(...data2024);
                const maxMonth2024 = months[data2024.indexOf(max2024)];
                const minMonth2024 = months[data2024.indexOf(min2024)];
                analysisText += `En 2024, el mes con mayor frecuencia fue <strong>${maxMonth2024}</strong> (<strong>${max2024.toLocaleString('es-CL')}</strong> casos), y el de menor fue <strong>${minMonth2024}</strong> (<strong>${min2024.toLocaleString('es-CL')}</strong> casos).\n`;

                // Identify peak and low for 2025 actual data
                const actual2025Values = data2025Actual.slice(0, currentMonthIndex + 1);
                if (actual2025Values.length > 0) {
                    const max2025Actual = Math.max(...actual2025Values);
                    const min2025Actual = Math.min(...actual2025Values);
                    const maxMonth2025Actual = months[data2025Actual.indexOf(max2025Actual)];
                    const minMonth2025Actual = months[actual2025Values.indexOf(min2025Actual)]; // Corrected index for minMonth2025Actual
                    analysisText += `Hasta el momento en 2025, el mes de mayor incidencia fue <strong>${maxMonth2025Actual}</strong> (<strong>${max2025Actual.toLocaleString('es-CL')}</strong> casos), y el de menor fue <strong>${minMonth2025Actual}</strong> (<strong>${min2025Actual.toLocaleString('es-CL')}</strong> casos).\n\n`;
                }


                analysisText += `La proyecci√≥n para los meses restantes de 2025 (a partir de <strong>${months[currentMonthIndex + 1] || 'Agosto'}</strong>) es de aproximadamente <strong>${Math.round(average2025).toLocaleString('es-CL')}</strong> casos por mes, con base en el promedio de los meses ya reportados de 2025.`;


            } else if (temporality === 'Weekly') {
                const weeks = Array.from({ length: 12 }, (_, i) => `Semana ${String(i + 1).padStart(2, '0')}`);
                let data2024 = [];
                let data2025 = [];
                let currentWeekIndex = -1; // Assuming data is available up to currentWeekIndex

                const year2024DataFiltered = weeklyDataRaw.filter(d => d.A√±o === 2024);
                const year2025DataFiltered = weeklyDataRaw.filter(d => d.A√±o === 2025);

                if (selectedCrime === 'All') {
                    weeks.forEach((week, index) => {
                        const sum24 = year2024DataFiltered.filter(d => d[week] !== undefined).reduce((acc, d) => acc + d[week], 0);
                        data2024.push(sum24);

                        const sum25 = year2025DataFiltered.filter(d => d[week] !== undefined).reduce((acc, d) => acc + d[week], 0);
                        data2025.push(sum25);
                        if (sum25 > 0) { // Assume data is present up to the last non-zero week
                           currentWeekIndex = index;
                        }
                    });
                } else {
                    const crimeData2024 = year2024DataFiltered.find(d => d.Delito === selectedCrime);
                    const crimeData2025 = year2025DataFiltered.find(d => d.Delito === selectedCrime);

                    weeks.forEach((week, index) => {
                        const val24 = (crimeData2024 && crimeData2024[week] !== undefined) ? crimeData2024[week] : 0;
                        data2024.push(val24);
                        const val25 = (crimeData2025 && crimeData2025[week] !== undefined) ? crimeData2025[week] : 0;
                        data2025.push(val25);
                        if (val25 > 0) {
                            currentWeekIndex = index;
                        }
                    });
                }

                analysisText += `An√°lisis Semanal para <strong>${dataName}</strong>:\n\n`;
                analysisText += `An√°lisis de las semanas disponibles en 2024 y 2025 (hasta la <strong>Semana ${currentWeekIndex + 1}</strong>):\n`;

                let total2024Partial = data2024.slice(0, currentWeekIndex + 1).reduce((sum, val) => sum + val, 0);
                let total2025Partial = data2025.slice(0, currentWeekIndex + 1).reduce((sum, val) => sum + val, 0);

                if (total2024Partial > 0) {
                    const changePartial = ((total2025Partial - total2024Partial) / total2024Partial * 100).toFixed(1);
                    analysisText += `Se observa un <strong>${changePartial > 0 ? 'incremento' : 'decremento'}</strong> del <strong>${Math.abs(changePartial)}%</strong> en 2025 respecto al mismo per√≠odo de 2024.\n`;
                } else if (total2025Partial > 0) {
                     analysisText += `Se ha registrado un <strong>aumento significativo</strong> en 2025 en comparaci√≥n con el mismo per√≠odo de 2024.\n`;
                } else {
                     analysisText += `Las cifras son <strong>consistentes</strong> en ambos a√±os para el per√≠odo analizado.\n`;
                }

                const max2024 = Math.max(...data2024.slice(0, currentWeekIndex + 1));
                const min2024 = Math.min(...data2024.slice(0, currentWeekIndex + 1));
                const maxWeek2024 = weeks[data2024.indexOf(max2024)];
                const minWeek2024 = weeks[data2024.indexOf(min2024)];
                analysisText += `En las semanas disponibles de 2024, el pico se alcanz√≥ en <strong>${maxWeek2024}</strong> (<strong>${max2024.toLocaleString('es-CL')}</strong> casos) y el punto m√°s bajo en <strong>${minWeek2024}</strong> (<strong>${min2024.toLocaleString('es-CL')}</strong> casos).\n`;

                const max2025 = Math.max(...data2025.slice(0, currentWeekIndex + 1));
                const min2025 = Math.min(...data2025.slice(0, currentWeekIndex + 1));
                const maxWeek2025 = weeks[data2025.indexOf(max2025)];
                const minWeek2025 = weeks[data2025.indexOf(min2025)];
                analysisText += `Para 2025, en las semanas con datos, la semana con m√°s casos fue la <strong>${maxWeek2025}</strong> (<strong>${max2025.toLocaleString('es-CL')}</strong> casos) y la de menor fue la <strong>${minWeek2025}</strong> (<strong>${min2025.toLocaleString('es-CL')}</strong> casos).`;
            }

            document.getElementById('dynamicAnalysis').innerHTML = `<p class="whitespace-pre-wrap">${analysisText}</p>`;
        }

        // Function to calculate and display key metrics
        function updateKeyMetrics() {
            // 1. Total Casos 2024 (A√±o completo)
            const total2024 = annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2024"], 0);
            document.getElementById('metric1').textContent = total2024.toLocaleString('es-CL');

            // 2. Total Casos 2025 (a la fecha)
            const total2025Partial = annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2025 (a la fecha)"], 0);
            document.getElementById('metric2').textContent = total2025Partial.toLocaleString('es-CL');

            // 3. Delito M√°s Frecuente (2024)
            let crimeFrequencies2024 = annualDataRaw.map(d => ({
                delito: d.Delito,
                total: d["Frecuencia 2024"]
            }));
            crimeFrequencies2024.sort((a, b) => b.total - a.total);
            const mostFrequent2024 = crimeFrequencies2024[0];
            document.getElementById('metric3-value').innerHTML = `<strong>${mostFrequent2024.delito}</strong><br>(${mostFrequent2024.total.toLocaleString('es-CL')})`;

            // 4. Delito M√°s Frecuente (2025 a la fecha)
            let crimeFrequencies2025 = annualDataRaw.map(d => ({
                delito: d.Delito,
                total: d["Frecuencia 2025 (a la fecha)"]
            }));
            crimeFrequencies2025.sort((a, b) => b.total - a.total);
            const mostFrequent2025 = crimeFrequencies2025[0];
            document.getElementById('metric4-value').innerHTML = `<strong>${mostFrequent2025.delito}</strong><br>(${mostFrequent2025.total.toLocaleString('es-CL')})`;


            // --- NUEVA M√âTRICA: 5. Variaci√≥n % (2025 vs Mismo Periodo 2024) ---
            const monthsForComparison = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio"]; // Up to July for 2025 partial data
            let total2024_comparable = 0;
            monthlyDataRaw.filter(d => d.A√±o === 2024).forEach(crimeData => {
                monthsForComparison.forEach(month => {
                    total2024_comparable += crimeData[month] || 0;
                });
            });

            const rawChange25_vs_24partial = total2024_comparable > 0 ? ((total2025Partial - total2024_comparable) / total2024_comparable * 100) : NaN;
            const change25_vs_24partial = isNaN(rawChange25_vs_24partial) ? 'N/A' : rawChange25_vs_24partial.toFixed(1);
            const metric5Element = document.getElementById('metric5');
            metric5Element.textContent = `${change25_vs_24partial}%`;
            if (change25_vs_24partial !== 'N/A') {
                metric5Element.classList.toggle('green', rawChange25_vs_24partial < 0); // Disminuci√≥n de delitos es 'bueno'
                metric5Element.classList.toggle('red', rawChange25_vs_24partial > 0);   // Aumento de delitos es 'malo'
            } else {
                metric5Element.classList.remove('green', 'red');
            }


            // --- REUBICADA Y RENOMBRADA: 6. Variaci√≥n % Total (2024 vs 2023) ---
            const total2023 = annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2023"], 0);
            const rawChange24_vs_23 = total2023 > 0 ? ((total2024 - total2023) / total2023 * 100) : NaN;
            const change24_vs_23 = isNaN(rawChange24_vs_23) ? 'N/A' : rawChange24_vs_23.toFixed(1);
            const metric6Element = document.getElementById('metric6');
            metric6Element.textContent = `${change24_vs_23}%`;
            if (change24_vs_23 !== 'N/A') {
                metric6Element.classList.toggle('green', rawChange24_vs_23 < 0);
                metric6Element.classList.toggle('red', rawChange24_vs_23 > 0);
            } else {
                metric6Element.classList.remove('green', 'red');
            }


            // 7. Robos con Violencia (√öltimo Mes 2025 - Julio)
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const robosViolenciaMonthly2025 = monthlyDataRaw.find(d => d.A√±o === 2025 && d.Delito === "ROBOS CON VIOLENCIA O INTIMIDACI√ìN");
            const julioRobosViolencia = robosViolenciaMonthly2025 ? robosViolenciaMonthly2025["Julio"] : 0;
            document.getElementById('metric7').textContent = julioRobosViolencia.toLocaleString('es-CL');

            // 8. Homicidios y Femicidios (√öltima Semana 2025 - Semana 12)
            const weeks = Array.from({ length: 12 }, (_, i) => `Semana ${String(i + 1).padStart(2, '0')}`);
            const homicidiosWeekly2025 = weeklyDataRaw.find(d => d.A√±o === 2025 && d.Delito === "HOMICIDIOS Y FEMICIDIOS");
            const semana12Homicidios = homicidiosWeekly2025 ? homicidiosWeekly2025["Semana 12"] : 0;
            document.getElementById('metric8').textContent = semana12Homicidios.toLocaleString('es-CL');
        }

        // Render Annual Chart
        function renderAnnualChart(selectedCrime = 'All') {
            if (annualChartInstance) {
                annualChartInstance.destroy();
            }

            let labels = ['2023', '2024', '2025 (a la fecha)'];
            let data2023 = [];
            let data2024 = [];
            let data2025 = [];

            if (selectedCrime === 'All') {
                data2023 = [annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2023"], 0)];
                data2024 = [annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2024"], 0)];
                data2025 = [annualDataRaw.reduce((sum, d) => sum + d["Frecuencia 2025 (a la fecha)"], 0)];
            } else {
                const crimeData = annualDataRaw.find(d => d.Delito === selectedCrime);
                if (crimeData) {
                    data2023 = [crimeData["Frecuencia 2023"]];
                    data2024 = [crimeData["Frecuencia 2024"]];
                    data2025 = [crimeData["Frecuencia 2025 (a la fecha)"]];
                }
            }

            const ctx = document.getElementById('annualChart').getContext('2d');
            annualChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Frecuencia 2023',
                            data: [data2023[0], 0, 0], // Only show 2023 data at 2023 bar
                            backgroundColor: 'rgba(76, 81, 191, 0.7)', // Purple
                            borderColor: 'rgba(76, 81, 191, 1)',
                            borderWidth: 1,
                            barPercentage: 0.8,
                            categoryPercentage: 0.8
                        },
                        {
                            label: 'Frecuencia 2024',
                            data: [0, data2024[0], 0], // Only show 2024 data at 2024 bar
                            backgroundColor: 'rgba(237, 137, 45, 0.7)', // Orange
                            borderColor: 'rgba(237, 137, 45, 1)',
                            borderWidth: 1,
                            barPercentage: 0.8,
                            categoryPercentage: 0.8
                        },
                        {
                            label: 'Frecuencia 2025 (a la fecha)',
                            data: [0, 0, data2025[0]], // Only show 2025 data at 2025 bar
                            backgroundColor: 'rgba(56, 178, 172, 0.7)', // Teal
                            borderColor: 'rgba(56, 178, 172, 1)',
                            borderWidth: 1,
                            barPercentage: 0.8,
                            categoryPercentage: 0.8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: selectedCrime === 'All' ? 'Frecuencia Total Anual de Delitos' : `Frecuencia Anual de: ${selectedCrime}`
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'A√±o'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frecuencia de Casos'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                }
            });
            generateAnalysisText('Annual', selectedCrime);
        }

        // Render Monthly Chart - Now Comparative with Projection for 2025 and segmented line
        function renderMonthlyChart(selectedCrime) {
            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
            }

            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            let data2024 = [];
            let data2025Actual = []; // Stores actual 2025 data points
            let sum2025Reported = 0;
            let count2025Reported = 0;
            let currentMonthIndex = -1; // Index of the last month with actual reported data > 0

            // --- Process 2024 Data ---
            if (selectedCrime === 'All') {
                months.forEach(month => {
                    const sum = monthlyDataRaw
                        .filter(d => d.A√±o === 2024 && d[month] !== undefined)
                        .reduce((acc, d) => acc + d[month], 0);
                    data2024.push(sum);
                });
            } else {
                const crimeData2024 = monthlyDataRaw.find(d => d.A√±o === 2024 && d.Delito === selectedCrime);
                months.forEach(month => {
                    data2024.push(crimeData2024 && crimeData2024[month] !== undefined ? crimeData2024[month] : 0);
                });
            }

            // --- Process 2025 Actual Data and determine last reported month ---
            // This loop populates data2025Actual with the real data, and tracks `currentMonthIndex`
            if (selectedCrime === 'All') {
                months.forEach((month, index) => {
                    const sumForMonth = monthlyDataRaw
                        .filter(d => d.A√±o === 2025 && d[month] !== undefined)
                        .reduce((acc, d) => acc + d[month], 0);

                    data2025Actual.push(sumForMonth); // Store the actual sum (even if it's 0, it's a reported 0)

                    if (sumForMonth > 0) { // Only count for average if there's actual positive data
                        sum2025Reported += sumForMonth;
                        count2025Reported++;
                        currentMonthIndex = index; // Update last month with positive actual data
                    }
                });
            } else {
                const crimeData2025Specific = monthlyDataRaw.find(d => d.A√±o === 2025 && d.Delito === selectedCrime);
                months.forEach((month, index) => {
                    const value = (crimeData2025Specific && crimeData2025Specific[month] !== undefined) ? crimeData2025Specific[month] : 0;
                    data2025Actual.push(value); // Store the actual value (even if 0)

                    if (value > 0) { // Only count for average if there's actual positive data
                        sum2025Reported += value;
                        count2025Reported++;
                        currentMonthIndex = index;
                    }
                });
            }

            // Calculate average for reported months in 2025
            const average2025 = count2025Reported > 0 ? sum2025Reported / count2025Reported : 0;

            // Create the final data2025 array with projections
            let data2025 = [...data2025Actual]; // Start with the collected actual data

            // Project values for remaining months in 2025
            for (let i = currentMonthIndex + 1; i < months.length; i++) {
                data2025[i] = Math.round(average2025); // Use rounded average for projection
            }

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: `Frecuencia 2024 (${selectedCrime === 'All' ? 'Total' : selectedCrime})`,
                            data: data2024,
                            borderColor: '#4c51bf', // Purple
                            backgroundColor: 'rgba(76, 81, 191, 0.2)',
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: `Frecuencia 2025 (Datos y Proyecci√≥n) (${selectedCrime === 'All' ? 'Total' : selectedCrime})`,
                            data: data2025,
                            borderColor: '#ed8936', // Base color, overridden by segment below
                            backgroundColor: 'rgba(237, 137, 45, 0.2)',
                            fill: false,
                            tension: 0.3,
                            segment: {
                                borderColor: ctxSegment => {
                                    // Make border solid for actual data, dashed for projected
                                    if (ctxSegment.p0DataIndex <= currentMonthIndex) {
                                        return '#ed8936'; // Solid orange
                                    }
                                    return '#ed8936'; // Orange, but dashed
                                },
                                borderDash: ctxSegment => {
                                    if (ctxSegment.p0DataIndex <= currentMonthIndex) {
                                        return []; // Solid line
                                    }
                                    return [5, 5]; // Dashed line
                                },
                                pointStyle: ctxSegment => {
                                    if (ctxSegment.dataIndex <= currentMonthIndex) {
                                        return 'circle'; // Circle for actual points
                                    }
                                    return 'rect'; // Square for projected points
                                },
                                radius: ctxSegment => { // Adjust radius for better visibility
                                    if (ctxSegment.dataIndex <= currentMonthIndex) {
                                        return 5;
                                    }
                                    return 4;
                                }
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Frecuencia Mensual de ${selectedCrime === 'All' ? 'Todos los Delitos' : selectedCrime} (2024 vs. 2025 Proyectado)`
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y;
                                    }
                                    // Check if the current point is in the projected segment
                                    const isProjected = context.dataset.label.includes("2025") && context.dataIndex > currentMonthIndex;
                                    if (isProjected) {
                                        label += ' (Proyecci√≥n)';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Mes'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frecuencia de Casos'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                }
            });
            generateAnalysisText('Monthly', selectedCrime);
        }

        // Render Weekly Chart - Now Comparative
        function renderWeeklyChart(selectedCrime) {
            if (weeklyChartInstance) {
                weeklyChartInstance.destroy();
            }

            const weeks = Array.from({ length: 12 }, (_, i) => `Semana ${String(i + 1).padStart(2, '0')}`);
            let data2024 = [];
            let data2025 = [];

            const year2024DataFiltered = weeklyDataRaw.filter(d => d.A√±o === 2024);
            const year2025DataFiltered = weeklyDataRaw.filter(d => d.A√±o === 2025);

            if (selectedCrime === 'All') {
                weeks.forEach((week, index) => {
                    const sum24 = year2024DataFiltered
                        .filter(d => d[week] !== undefined)
                        .reduce((acc, d) => acc + d[week], 0);
                    data2024.push(sum24);

                    const sum25 = year2025DataFiltered
                        .filter(d => d[week] !== undefined)
                        .reduce((acc, d) => acc + d[week], 0);
                    data2025.push(sum25);
                });
            } else {
                const crimeData2024 = year2024DataFiltered.find(d => d.Delito === selectedCrime);
                const crimeData2025 = year2025DataFiltered.find(d => d.Delito === selectedCrime);

                weeks.forEach(week => {
                    data2024.push(crimeData2024 && crimeData2024[week] !== undefined ? crimeData2024[week] : 0);
                    data2025.push(crimeData2025 && crimeData2025[week] !== undefined ? crimeData2025[week] : 0);
                });
            }

            const ctx = document.getElementById('weeklyChart').getContext('2d');
            weeklyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: `Frecuencia Semanal 2024 (${selectedCrime === 'All' ? 'Total' : selectedCrime})`,
                            data: data2024,
                            borderColor: '#38b2ac', // Teal
                            backgroundColor: 'rgba(56, 178, 172, 0.2)',
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: `Frecuencia Semanal 2025 (a la fecha) (${selectedCrime === 'All' ? 'Total' : selectedCrime})`,
                            data: data2025,
                            borderColor: '#6b46c1', // Darker Purple
                            backgroundColor: 'rgba(107, 70, 193, 0.2)',
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Frecuencia Semanal de ${selectedCrime === 'All' ? 'Todos los Delitos' : selectedCrime} (2024 vs. 2025)`
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Semana'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frecuencia de Casos'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                }
            });
            generateAnalysisText('Weekly', selectedCrime);
        }

        // Event Listeners for tabs
        document.getElementById('tabAnnual').addEventListener('click', () => {
            document.querySelectorAll('.temporal-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('annualContent').classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tabAnnual').classList.add('active');
            currentTemporality = 'Annual';
            renderAnnualChart(document.getElementById('annualCrimeSelect').value);
        });

        document.getElementById('tabMonthly').addEventListener('click', () => {
            document.querySelectorAll('.temporal-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('monthlyContent').classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tabMonthly').classList.add('active');
            currentTemporality = 'Monthly';
            renderMonthlyChart(document.getElementById('monthlyCrimeSelect').value);
        });

        document.getElementById('tabWeekly').addEventListener('click', () => {
            document.querySelectorAll('.temporal-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('weeklyContent').classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tabWeekly').classList.add('active');
            currentTemporality = 'Weekly';
            renderWeeklyChart(document.getElementById('weeklyCrimeSelect').value);
        });

        // Event Listeners for filters
        document.getElementById('annualCrimeSelect').addEventListener('change', (event) => {
            renderAnnualChart(event.target.value);
        });

        document.getElementById('monthlyCrimeSelect').addEventListener('change', (event) => {
            renderMonthlyChart(event.target.value);
        });

        document.getElementById('weeklyCrimeSelect').addEventListener('change', (event) => {
            renderWeeklyChart(event.target.value);
        });

        // Initial render
        document.addEventListener('DOMContentLoaded', () => {
            populateCrimeSelects();
            generateGeneralAnalysisText(); // Generate initial general analysis
            updateKeyMetrics(); // Generate and display key metrics
            renderAnnualChart('All'); // Render annual chart by default
            generateAnalysisText('Annual', 'All'); // Initial specific analysis text
        });

    </script>
</body>
</html>
